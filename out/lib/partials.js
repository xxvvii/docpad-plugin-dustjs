// Generated by CoffeeScript 1.7.1
(function() {
  var fs, loadFile;

  fs = require('fs');

  loadFile = function(dust, filename, name) {
    return fs.readFile(filename, function(err, data) {
      var e, tmpl;
      if (err) {
        console.log(err);
      } else {
        try {
          tmpl = dust.compile(data.toString(), name);
          dust.loadSource(tmpl);
          console.log(name);
        } catch (_error) {
          e = _error;
          console.log(e);
        }
      }
    });
  };

  module.exports = function(dust, dir) {
    var path, walk;
    walk = require('walk').walk;
    path = require('path');
    walk(dir).on('file', function(root, stat, next) {
      var basename, extname, filename, name, prefix;
      filename = path.resolve(root + '/' + stat.name);
      basename = path.basename(filename, '.dust');
      extname = path.extname(filename);
      prefix = path.relative(dir, root);
      prefix = prefix.replace(/\\/g, '/');
      name = prefix ? prefix + '/' + basename : basename;
      if (extname === '.dust') {
        fs.watch(filename, function(event, file) {
          if (event === 'change') {
            console.log(file + ' has changed, reloading...');
            return loadFile(dust, filename, name);
          }
        });
        loadFile(dust, filename, name);
      }
      return next();
    });
  };

}).call(this);
